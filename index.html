<!DOCTYPE HTML>
<html lang=en>
<title>Feed viewer</title>
<link rel=stylesheet href=/css>

<h1>Feed viewer</h1>

<form action=javascript: onsubmit="
  var fd = new FormData (this);
  var status = document.querySelector ('.status');
  status.classList.remove ('error');
  status.querySelector ('.message').textContent = 'Loading...';
  status.querySelector ('progress').hidden = false;
  status.hidden = false;
  fetch ('/viewer', {method: 'POST', body: fd}).then (function (res) {
    return res.json ();
  }).then (function (json) {
    if (json.ok) {
      fillResult (json);
      status.hidden = true;
    } else {
      status.classList.add ('error');
      status.querySelector ('.message').textContent = json.error;
      status.querySelector ('progress').hidden = true;
    }
  });
  history.pushState (null, null, location.pathname + '?url=' + encodeURIComponent (elements.url.value));
">
  <p><label><strong>URL</strong>: <input type=url name=url required></label>
  <p><button type=submit>Show</button>

  <p class=status hidden><progress></progress> <span class=message></span>
</form>

<section id=feed-props hidden>
  <h1>Feed properties</h1>

  <table>
    <tbody>
      <tr>
        <th>Web page URL
        <td data-prop=page_url data-type=url>
      <tr>
        <th>Feed URL
        <td data-prop=feed_url data-type=url>
      <tr>
        <th>Previous feed URL
        <td data-prop=prev_feed_url data-type=url>
      <tr>
        <th>Next feed URL
        <td data-prop=next_feed_url data-type=url>
      <tr>
        <th>Icon
        <td data-prop=icon data-type=image>
      <tr>
        <th>Logo
        <td data-prop=logo data-type=image>
    <tbody>
      <tr>
        <th>Title
        <td data-prop=title>
      <tr>
        <th>Subtitle
        <td data-prop=subtitle>
      <tr>
        <th>Description
        <td data-prop=description>
    <tbody>
      <tr>
        <th>Last modified
        <td data-prop=updated>
      <tr>
        <th>Authors
        <td data-prop=authors data-type=person-list>
  </table>
</section>

<section id=entries hidden>
  <h1>Entries</h1>

  <template id=template-entry>
    <section>
      <h1>Entry</h1>
      <table>
        <tbody>
          <tr>
            <th>Web page URL
            <td data-prop=page_url data-type=url>
          <tr>
            <th>Thumbnail
            <td data-prop=thumbnail data-type=image>
        <tbody>
          <tr>
            <th>Title
            <td data-prop=title>
          <tr>
            <th>Summary
            <td data-prop=summary>
          <tr>
            <th>Content
            <td data-prop=content>
          <tr>
            <th>Duration
            <td data-prop=duration>
          <tr>
            <th>Enclosures
            <td data-prop=enclosures data-type=enclosure-list>
          <tr>
            <th>Categories
            <td data-prop=categories data-type=category-set>
        <tbody>
          <tr>
            <th>Published
            <td data-prop=published>
          <tr>
            <th>Updated
            <td data-prop=updated>
          <tr>
            <th>Authors
            <td data-prop=authors data-type=person-list>
      </table>
    </section>
  </template>
</section>

<template id=template-datetime>
  Date: <time></time>
</template>

<template id=template-node>
  DOM: <pre></pre>
</template>

<template id=template-image>
  <div>
    Image:
    <table class=image>
      <tbody>
        <tr>
          <th>URL
          <td data-prop=url data-type=image-url>
        <tr>
          <th>Height
          <td data-prop=height>
        <tr>
          <th>Width
          <td data-prop=width>
    </table>
  </div>
</template>

<template id=template-enclosure>
  <div>
    Enclosure:
    <table class=enclosure>
      <tbody>
        <tr>
          <th>URL
          <td data-prop=url data-type=url>
        <tr>
          <th>MIME type
          <td data-prop=type>
        <tr>
          <th>File size
          <td data-prop=length>
    </table>
  </div>
</template>

<template id=template-person>
  <div>
    Person:
    <table class=person>
      <tbody>
        <tr>
          <th>Name
          <td data-prop=name>
        <tr>
          <th>Email
          <td data-prop=email>
        <tr>
          <th>Page URL
          <td data-prop=page-url data-type=url>
        <tr>
          <th>Icon
          <td data-prop=icon data-type=image>
    </table>
  </div>
</template>

<script>
  var feedProps = document.querySelector ('#feed-props');
  var entriesSection = document.querySelector ('#entries');

  function fillResult (json) {
    Array.prototype.forEach.call (feedProps.querySelectorAll ('[data-prop]'), function (el) {
      setPropValue (el, json.parsed[el.getAttribute ('data-prop')]);
    });
    Array.prototype.forEach.call (entriesSection.querySelectorAll ('section'), function (el) {
      if (el.parentNode) el.parentNode.removeChild (el);
    });
    var entryTemplate = entriesSection.querySelector ('#template-entry');
    json.parsed.entries.forEach (function (entry) {
      var f = entryTemplate.content.cloneNode (true);
      Array.prototype.forEach.call (f.querySelectorAll ('[data-prop]'), function (el) {
        setPropValue (el, entry[el.getAttribute ('data-prop')]);
      });
      entryTemplate.parentNode.appendChild (f);
    });
    feedProps.hidden = false;
    entriesSection.hidden = false;
  } // fillResult

  function setPropValue (el, value) {
    var type = el.getAttribute ('data-type');
    if (value == null) {
      el.textContent = '(null)';
    } else if (type === 'url') {
      el.innerHTML = '<a rel=noreferrer target=page><code></code></a>';
      el.firstChild.firstChild.textContent = value;
      el.firstChild.href = value;
    } else if (type === 'image-url') {
      el.innerHTML = '<a rel=noreferrer target=page><img><code></code></a>';
      el.firstChild.firstChild.src = value;
      el.firstChild.lastChild.textContent = value;
      el.firstChild.href = value;
    } else if (type === 'person-list') {
      if (value.length) {
        el.textContent = '';
        var template = document.querySelector ('#template-person');
        value.forEach (function (person) {
          var f = template.content.cloneNode (true);
          Array.prototype.forEach.call (f.querySelectorAll ('[data-prop]'), function (el) {
            setPropValue (el, person[el.getAttribute ('data-prop')]);
          });
          el.appendChild (f);
        });
      } else {
        el.textContent = '(empty)';
      }
    } else if (type === 'enclosure-list') {
      if (value.length) {
        el.textContent = '';
        var template = document.querySelector ('#template-enclosure');
        value.forEach (function (en) {
          var f = template.content.cloneNode (true);
          Array.prototype.forEach.call (f.querySelectorAll ('[data-prop]'), function (el) {
            setPropValue (el, en[el.getAttribute ('data-prop')]);
          });
          el.appendChild (f);
        });
      } else {
        el.textContent = '(empty)';
      }
    } else if (type === 'image') {
      el.textContent = '';
      var template = document.querySelector ('#template-image');
      var f = template.content.cloneNode (true);
      Array.prototype.forEach.call (f.querySelectorAll ('[data-prop]'), function (el) {
        setPropValue (el, value[el.getAttribute ('data-prop')]);
      });
      el.appendChild (f);
    } else if (type === 'category-set') {
      el.textContent = '';
      for (c in value) {
        el.appendChild (document.createTextNode (' '));
        var d = document.createElement ('data');
        d.textContent = c;
        el.appendChild (d);
      }
    } else if (value instanceof Array) {
      if (value[0] === 'datetime') {
        el.textContent = '';
        var template = document.querySelector ('#template-datetime');
        el.appendChild (template.content.cloneNode (true));
        var time = el.querySelector ('time');
        time.textContent = new Date (value[1] * 1000).toLocaleString ();
        time.dateTime = new Date (value[1] * 1000).toISOString ();
      } else if (value[0] === 'node') {
        el.textContent = '';
        var template = document.querySelector ('#template-node');
        el.appendChild (template.content.cloneNode (true));
        el.querySelector ('pre').textContent = value[1];
      } else {
        el.textContent = value;
      }
    } else {
      el.innerHTML = '<data></data>';
      el.firstChild.textContent = value;
    }
  } // setPropValue
</script>

<script>
  var params = {};
  location.search.replace (/^\?/, '').split (/&/).forEach (function (_) {
    var nv = _.split (/=/, 2);
    params[decodeURIComponent (nv[0])] = decodeURIComponent (nv[1]);
  });
  if (params.url) {
    var input = document.querySelector ('input[name=url]');
    input.value = params.url;
    input.form.querySelector ('[type=submit]').click ();
  }
</script>
